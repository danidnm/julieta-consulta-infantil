<div class="p-4 space-y-4" x-data="{
  exporting: false,
  cleaning: false,
  exportLocalStorage() {
    try {
      this.exporting = true;
      const patientsRaw = localStorage.getItem('patients') ?? '[]';
      const reviewsRaw = localStorage.getItem('reviews') ?? '{}';

      // Intentamos pretty-print de JSON; si falla, dejamos el crudo
      const pretty = (raw, fallback) => {
        try { return JSON.stringify(JSON.parse(raw), null, 2); } catch(_) { return fallback ?? String(raw); }
      };

      const patientsTxt = pretty(patientsRaw, patientsRaw);
      const reviewsTxt = pretty(reviewsRaw, reviewsRaw);

      const now = new Date();
      const pad = n => String(n).padStart(2, '0');
      const stamp = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}-${pad(now.getSeconds())}`;

      const content = [
        `Exportación de datos (${stamp})`,
        '',
        '=== patients ===',
        patientsTxt,
        '',
        '=== reviews ===',
        reviewsTxt,
        ''
      ].join('\n');

      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `export-localstorage-${stamp}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      console.error('Error exportando LocalStorage', e);
      alert('No se pudo exportar el contenido de LocalStorage. Revisa la consola para más detalles.');
    } finally {
      this.exporting = false;
    }
  },
  async removePatientPhotos() {
    try {
      if (!confirm('¿Seguro que quieres borrar las fotos de todos los pacientes? Esta acción no se puede deshacer.')) return;
      this.cleaning = true;
      const raw = localStorage.getItem('patients') ?? '[]';
      let patients = [];
      try { patients = JSON.parse(raw); } catch(_) { patients = []; }
      if (!Array.isArray(patients)) patients = [];

      // Limpia campos de foto comunes
      let changed = 0;
      patients = patients.map(p => {
        const copy = { ...p };
        const before = JSON.stringify(copy);
        // El campo usado por la app es `photo`; por seguridad, limpiamos otros nombres también
        delete copy.photo;
        delete copy.avatar;
        delete copy.image;
        delete copy.imageUrl;
        delete copy.picture;
        if (Array.isArray(copy.photos)) copy.photos = [];
        const after = JSON.stringify(copy);
        if (before !== after) changed++;
        return copy;
      });

      // Guardamos de nuevo en LocalStorage
      localStorage.setItem('patients', JSON.stringify(patients));

      alert(`Se han eliminado las fotos. Fichas actualizadas: ${changed}`);
    } catch (e) {
      console.error('Error limpiando fotos de pacientes', e);
      alert('Ocurrió un error al borrar las fotos. Revisa la consola para más detalles.');
    } finally {
      this.cleaning = false;
    }
  }
}">
  <h2 class="text-2xl font-bold text-primary text-center">⚙️ Configuración</h2>
  <div class="max-w-xl mx-auto space-y-6">
    <div>
      <p class="text-center text-sm text-gray-600">Descarga un archivo .txt con el contenido de LocalStorage (claves: <code>patients</code> y <code>reviews</code>).</p>
      <div class="flex justify-center mt-2">
        <button class="btn btn-primary" @click="exportLocalStorage()" :disabled="exporting">
          <span x-show="!exporting">Descargar datos (txt)</span>
          <span x-show="exporting" class="loading loading-spinner loading-sm"></span>
        </button>
      </div>
    </div>

    <div class="border-t pt-4">
      <p class="text-center text-sm text-gray-600">Borrar las fotos de todos los pacientes y guardar de nuevo las fichas en LocalStorage.</p>
      <div class="flex justify-center mt-2">
        <button class="btn btn-error" @click="removePatientPhotos()" :disabled="cleaning">
          <span x-show="!cleaning">Borrar fotos de pacientes</span>
          <span x-show="cleaning" class="loading loading-spinner loading-sm"></span>
        </button>
      </div>
    </div>
  </div>
</div>
